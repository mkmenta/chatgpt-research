{% extends "layouts/boilerplate.html" %}
{% block body %}
<div class="row h-100">

    <div class="col-2">
        <div class="card">
            <div class="card-header">
                {% if current_user.admin %}
                <form action="/" method="GET">
                    <select class="form-select" name="user_id" onchange="this.form.submit()">
                        {% for user in users %}
                        <option value="{{user.id}}" {% if user.id==user_to_show.id %} selected {%endif%}>
                            {{user.username}}
                        </option>
                        {% endfor %}
                    </select>
                </form>
                {% else %}
                {{ current_user.username }}
                {% endif %}
            </div>
            <ul class="list-group list-group-flush">
                <button type="button" onclick="window.location='/'+window.location.search;"
                    class="list-group-item list-group-item-action">
                    New chat
                </button>
                {% for chat in chats %}
                <button type="button" onclick="window.location='/{{chat.id}}'+window.location.search;"
                    class="list-group-item list-group-item-action {% if chat.id==current_chat.id %} active {% endif %}">
                    {{chat.title}}
                </button>
                {% endfor %}

            </ul>
        </div>
    </div>
    <div class="col-10 h-100 d-flex flex-column">
        <div class="row overflow-auto" id="allMessages" style="max-height: 80vh">
            {% if current_chat is not none%}
            {% for message in current_chat.messages %}
            <div class="border-bottom p-2 d-flex" style="font-size: small;">
                <img {% if message.role=="user" %} src="{{ url_for('static', filename='imgs/user.gif') }}" {% else %}
                    src="{{ url_for('static', filename='imgs/openai.gif') }}" {% endif %} class="rounded-circle mr-1"
                    width="40" height="40">
                <span class="px-3" style="white-space: pre-line;">
                    {{ message.content }}
                </span>
            </div>
            {%endfor%}
            {%endif%}
            <div class="border-bottom p-2 d-flex new-messages" style="font-size: small; display: none!important;">
                <img src="{{ url_for('static', filename='imgs/user.gif') }}" class="rounded-circle mr-1" width="40"
                    height="40">
                <span class="px-3" style="white-space: pre-line;">
                    <p id="newMessage"></p>
                </span>
            </div>
            <div class="border-bottom p-2 d-flex new-messages" style="font-size: small; display: none!important;">
                <img src="{{ url_for('static', filename='imgs/openai.gif') }}" class="rounded-circle mr-1" width="40"
                    height="40">
                <span class="px-3" style="white-space: pre-line;">
                    <p>...</p>
                </span>
            </div>
            <script src="{{ url_for('static', filename='javascripts/showNewMessage.js') }}"></script>
            <script>
                const allMessages = document.getElementById('allMessages');
                allMessages.scrollTo(0, allMessages.scrollHeight);
            </script>
        </div>
        <div class="row mt-auto py-3 px-4 border-top" style="height: 10vh">
            <form {% if current_chat is not none%} action="/{{ current_chat.id }}/messages/send" {% else %}
                action="/new/messages/send" {% endif %} method="POST" onsubmit="showNewMessage()" novalidate>
                <div class="input-group">
                    <input id="newMessageInput" type="text" class="form-control" placeholder="Type your message"
                        name="messageInput">
                    <input id="newMessageInputHidden" type="hidden" name="message" value="">
                    <button id="sendButton" class="btn btn-primary" {%if user_to_show !=current_user%} disabled
                        {%endif%}>Send</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}